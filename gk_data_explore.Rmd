---
title: "Greenkeeper Data Explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries, Functions & Data
```{r}
library(data.table)
library(dplyr)
library(lubridate)

commits_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_commits.csv"
comments_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_comments.csv"
events_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_events.csv"
issues_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_issues.csv"
pack_names_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_package_names.csv"

commits <- fread(commits_file, nThread=20)
comments <- fread(comments_file, nThread=20)
events <- fread(events_file, nThread=20)
issues <- fread(issues_file, nThread=20)
package_names <- fread(pack_names_file, nThread=20)


split_semver <- function(v) {
  return (unlist(strsplit(v, "\\.")))
}

major_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[1]) > as.numeric(split_semver(old_v)[1]))
}

minor_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[2]) > as.numeric(split_semver(old_v)[2]))
}

patch_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[3]) > as.numeric(split_semver(old_v)[3]))
}

get_update_type <- function(row) {
  curr_v <- row['issue_dependency_actual_version']
  next_v <- row['issue_dependency_next_version']
  if (major_versions_are_different(curr_v, next_v)) {
    return("major")
  } else if (minor_versions_are_different(curr_v, next_v)) {
    return("minor")
  } else {
    return("patch")
  }
}
```


## General Stats
- 123,089 Issues opened by Greenkeeper (GKI)
- 79,079 GKIs with issue_dependency_name, actual_version, and next_version
- 7 types of issue body parsers on the GKIs
  - BundleUpdateIssueBodyParser (18,582)
  - NewDepVersionIssueBodyParser (28,708)
  - NewDepVersion2IssueBodyParser (5,977)
  - NewDepVersion3IssueBodyParser (233)
  - NewDepVersion4IssueBodyParser (3,245)
  - NewDepUpdatedFromToIssueBodyParser (60,497)
  - NewDepUpdatedFromTo2IssueBodyParser (61)
```{r}
greenkeeper_login <- 
  "greenkeeper[bot]"
gki <- 
  issues[issue_user_login == greenkeeper_login]
null_values <- 
  c("", "undefined")
gki_with_dependency <- 
  gki[!(issue_dependency_name %in% null_values) & !(issue_dependency_actual_version %in% null_values) & !(issue_dependency_next_version %in% null_values)]
```

## RQ1: Types of updates (major, minor, patch) that break a client's build
Of 79,079 GKIs:
- Major: 122
- Minor: 27226
- Patch: 51731
```{r}
update_type <- apply(gki_with_dependency, 1, get_update_type)
gki_with_dependency <- cbind(gki_with_dependency, update_type)
gki_with_dependency$update_type <- factor(gki_with_dependency$update_type)
```
### Plot frequency of types of breaking updates
```{r}
freqs <- table(gki_with_dependency$update_type)
## Make the freqs numbers (rather than factors)
freqs <- as.numeric(as.character(freqs))
## Find a range of y's that'll leave sufficient space above the tallest bar
ylim <- c(0, 1.1*max(freqs))
## Plot and store
# png("plots/breaking_update_type_counts.png")
bp <- barplot(
  height=freqs,
  ylim=ylim,
  col=rgb(0.8, 0.1, 0.1, 0.5),
  xlab="Update Type",
  names.arg=c("major", "minor", "patch"), 
  ylab="Count",
  main="Counts of Breaking Update Types"
)
text(x=bp, y=freqs, label=freqs, pos=3, cex=0.8, col="red")
# dev.off()
```

### What packages cause the most breakages?
```{r}
ghi_with_dependency_name = gki[!(issue_dependency_name %in% null_values)]
packages_count = data.table(as.data.frame(table(ghi_with_dependency_name$issue_dependency_name)))
first_ten = head(packages_count[order(-Freq)], 10)
ylim <- c(0, 1.1*max(first_ten$Freq))
# png("plots/most_frequent_breaking_provider_packages.png")
bp <- barplot(
  first_ten$Freq,
  ylim=ylim,
  col=rgb(0.0, 0.2, 0.8, 0.5),
  names.arg=first_ten$Var1, 
  horiz=FALSE, 
  cex.names=0.8, 
  main="Most Frequent Breaking Packages",
  ylab="Times Package Broke a Client's Build",
  las=2
)
text(x=bp, y=first_ten$Freq, label=first_ten$Freq, pos=3, cex=0.7, col=rgb(0.0, 0.1, 0.9, 0.9))
# dev.off()
```


### How many issues per day/week/month are opened by the bot?
#### Day of Week
```{r}
gki.created_at <- gki[,'issue_created_at']

gki.created_at %>% 
  group_by(day_of_week=as.POSIXlt(issue_created_at)$wday) %>% 
  tally() ->
  day_of_week_issues

# png("plots/breaking_updates_day_of_week.png")
barplot(height=day_of_week_issues$n,
  main="Day of Week Issues Opened by Greeneeper",
  xlab="",
  ylab="Issues",
  col="lightgreen",
  names.arg=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"),
  cex.names=0.8,
  las=1
)
# dev.off()
```

#### Day of Month
```{r}
gki.created_at %>% 
  group_by(day_of_month=as.POSIXlt(issue_created_at)$mday) %>% 
  tally() ->
  day_of_month_issues

# png("plots/breaking_updates_day_of_month.png")
barplot(height=day_of_month_issues$n,
  main="Day of Month Issues Opened by Greeneeper",
  xlab="",
  ylab="Issues",
  col="forestgreen",
  names.arg=seq(1, 31),
  cex.names=0.8,
  las=1
)
# dev.off()
```

#### Week
```{r}
gki.created_at %>% 
  group_by(week=floor_date(issue_created_at, "week")) %>% 
  tally() ->
  weekly_issues

# png("plots/breaking_updates_opened_per_week.png")
barplot(height=weekly_issues$n,
  main="Weekly Issues Opened by Greeneeper",
  xlab="",
  ylab="Issues",
  col="deepskyblue",
  names.arg=weekly_issues$week,
  cex.names=0.9,
  las=2
)
# dev.off()

```

#### Month
```{r}
gki.created_at %>% 
  group_by(month=format(floor_date(issue_created_at, "month"), "%Y-%m")) %>% 
  tally() ->
  monthly_issues

# png("plots/breaking_updates_opened_per_month.png")
barplot(height=monthly_issues$n,
  main="Monthly Issues Opened by Greeneeper",
  xlab="",
  ylab="Issues",
  col="darkmagenta",
  names.arg=monthly_issues$month,
  cex.names=0.9,
  las=2
)
# dev.off()
```

#### Year
```{r}
gki.created_at %>% 
  group_by(year=floor_date(issue_created_at, "year")) %>% 
  tally() ->
  yearly_issues

```

## Linking issue comments to issues
Example: https://github.com/jubianchi/semver-check/issues/76
Issue_id = 614969004
```{r}
issue = gk_issues[issue_id == 614969004]
issue
comments_for_issue = gk_comments[comment_issue_id == issue$issue_id]

names(gk_events)
events_for_issue = gk_events[event_issue_id == issue$issue_id]
```



