---
title: "Greenkeeper Data Explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries, Functions & Data
```{r}
library(data.table)

commits_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_commits.csv"
comments_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_comments.csv"
events_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_events.csv"
issues_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_issues.csv"
pack_names_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_package_names.csv"

commits <- fread(commits_file, nThread=20)
comments <- fread(comments_file, nThread=20)
events <- fread(events_file, nThread=20)
issues <- fread(issues_file, nThread=20)
package_names <- fread(pack_names_file, nThread=20)


split_semver <- function(v) {
  return (unlist(strsplit(v, "\\.")))
}

major_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[1]) > as.numeric(split_semver(old_v)[1]))
}

minor_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[2]) > as.numeric(split_semver(old_v)[2]))
}

patch_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[3]) > as.numeric(split_semver(old_v)[3]))
}
```


## General Stats
- 123,089 Issues opened by Greenkeeper (GKI)
- 79,079 GKIs with issue_dependency_name, actual_version, and next_version
- 7 types of issue body parsers on the GKIs
  - BundleUpdateIssueBodyParser (18,582)
  - NewDepVersionIssueBodyParser (28,708)
  - NewDepVersion2IssueBodyParser (5,977)
  - NewDepVersion3IssueBodyParser (233)
  - NewDepVersion4IssueBodyParser (3,245)
  - NewDepUpdatedFromToIssueBodyParser (60,497)
  - NewDepUpdatedFromTo2IssueBodyParser (61)
```{r}
greenkeeper_login <- 
  "greenkeeper[bot]"
issues_opened_by_gk <- 
  issues[issue_user_login == greenkeeper_login]
null_values <- 
  c("", "undefined")
gki_with_dependency <- 
  issues_opened_by_gk[!(issue_dependency_name %in% null_values) & !(issue_dependency_actual_version %in% null_values) & !(issue_dependency_next_version %in% null_values)]
```

## RQ1: Types of updates (major, minor, patch) that break a client's build
Of 79,079 GKIs:
- Major: 122
- Minor: 27226
- Patch: 51731
```{r}

get_update_type <- function(row) {
  curr_v <- row['issue_dependency_actual_version']
  next_v <- row['issue_dependency_next_version']
  if (major_versions_are_different(curr_v, next_v)) {
    return("major")
  } else if (minor_versions_are_different(curr_v, next_v)) {
    return("minor")
  } else {
    return("patch")
  }
}
update_type <- apply(gki_with_dependency, 1, get_update_type)
gki_with_dependency <- cbind(gki_with_dependency, update_type)
gki_with_dependency$update_type <- factor(gki_with_dependency$update_type)
```
### Plot frequency of types of breaking updates
```{r}
freqs <- table(gki_with_dependency$update_type)
## Make the freqs numbers (rather than factors)
freqs <- as.numeric(as.character(freqs))
## Find a range of y's that'll leave sufficient space above the tallest bar
ylim <- c(0, 1.1*max(freqs))
## Plot and store
bp <- barplot(
  height=freqs,
  ylim=ylim,
  col=rgb(0.8, 0.1, 0.1, 0.5),
  xlab="Update Type",
  ylab="Count",
  main="Counts of Breaking Update Types"
)
text(x=bp, y=freqs, label=freqs, pos=3, cex=0.8, col="red")
```


### What packages cause the most breakages?
```{r}
ghi_with_dependency_name = issues_opened_by_gk[!(issue_dependency_name %in% null_values)]
packages_count = data.table(as.data.frame(table(ghi_with_dependency_name$issue_dependency_name)))
first_ten = head(packages_count[order(-Freq)], 10)
ylim <- c(0, 1.1*max(first_ten$Freq))
bp <- barplot(
  first_ten$Freq,
  ylim=ylim,
  col=rgb(0.0, 0.2, 0.8, 0.5),
  names.arg=first_ten$Var1, 
  horiz=FALSE, 
  cex.names=0.8, 
  main="Most Frequent Breaking Packages",
  ylab="Times Package Broke a Client's Build",
  las=2
)
text(x=bp, y=first_ten$Freq, label=first_ten$Freq, pos=3, cex=0.7, col=rgb(0.0, 0.1, 0.9, 0.9))

```



## Linking issue comments to issues
Example: https://github.com/jubianchi/semver-check/issues/76
Issue_id = 614969004
```{r}
issue = gk_issues[issue_id == 614969004]
issue
comments_for_issue = gk_comments[comment_issue_id == issue$issue_id]

names(gk_events)
events_for_issue = gk_events[event_issue_id == issue$issue_id]
```



