---
title: "Greenkeeper Data Explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries, Functions & Data
```{r}
library(data.table)

commits_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_commits.csv"
comments_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_comments.csv"
events_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_events.csv"
issues_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_issues.csv"
pack_names_file <- "/home/local/SAIL/filipe-cogo/wip-19-filipe-npm_greenkeeper_build_failures-data/2020-09-08/greenkeeper_package_names.csv"

commits <- fread(commits_file, nThread=20)
comments <- fread(comments_file, nThread=20)
events <- fread(events_file, nThread=20)
issues <- fread(issues_file, nThread=20)
package_names <- fread(pack_names_file, nThread=20)


split_semver <- function(v) {
  return (unlist(strsplit(v, "\\.")))
}

major_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[1]) > as.numeric(split_semver(old_v)[1]))
}

minor_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[2]) > as.numeric(split_semver(old_v)[2]))
}

patch_versions_are_different <- function(old_v, new_v) {
  return (as.numeric(split_semver(new_v)[3]) > as.numeric(split_semver(old_v)[3]))
}
```


## General Stats
- 123,089 Issues opened by Greenkeeper (GKI)
- 79,079 GKIs with issue_dependency_name, actual_version, and next_version
- 7 types of issue body parsers on the GKIs
  - BundleUpdateIssueBodyParser (18,582)
  - NewDepVersionIssueBodyParser (28,708)
  - NewDepVersion2IssueBodyParser (5,977)
  - NewDepVersion3IssueBodyParser (233)
  - NewDepVersion4IssueBodyParser (3,245)
  - NewDepUpdatedFromToIssueBodyParser (60,497)
  - NewDepUpdatedFromTo2IssueBodyParser (61)
```{r}
greenkeeper_login <- "greenkeeper[bot]"
issues_opened_by_gk <- issues[issue_user_login == greenkeeper_login]
null_values = c("", "undefined")
gki_with_dependency <- issues_opened_by_gk[!(issue_dependency_name %in% null_values) & !(issue_dependency_actual_version %in% null_values) & !(issue_dependency_next_version %in% null_values)]
```

## RQ1: Types of updates (major, minor, patch) that break a client's build
Of 79,079 GKIs:
- Major: 122
- Minor: 27226
- Patch: 51731
```{r}
types_count <- data.frame(matrix(data=c(0, 0, 0), ncol=3, nrow=1))
x <- c("major", "minor", "patch")
colnames(types_count) <- x
for (row in 1:nrow(gki_with_dependency)) {
  count <- count + 1  
  curr_v <- gki_with_dependency[row,]$issue_dependency_actual_version
  next_v <- gki_with_dependency[row,]$issue_dependency_next_version
  if (major_versions_are_different(curr_v, next_v)) {
    types_count$major <- types_count$major + 1
  } else if (minor_versions_are_different(curr_v, next_v)) {
    types_count$minor <- types_count$minor + 1
  } else {
    types_count$patch <- types_count$patch + 1
  }
}
barplot(c(types_count$major, types_count$minor, types_count$patch))
```


## What packages cause the most breakages?
```{r}
ghi_with_dependency_name = issues_opened_by_gk[!(issue_dependency_name %in% null_values)]
packages_count = data.table(as.data.frame(table(ghi_with_dependency_name$issue_dependency_name)))
first_ten = head(packages_count[order(-Freq)], 20)

barplot(first_ten$Freq, names.arg=first_ten$Var1, horiz=FALSE, cex.names=0.8, main="Most Frequent Breaking Packages",las=2)
```



## Linking issue comments to issues
Example: https://github.com/jubianchi/semver-check/issues/76
Issue_id = 614969004
```{r}
issue = gk_issues[issue_id == 614969004]
issue
comments_for_issue = gk_comments[comment_issue_id == issue$issue_id]

names(gk_events)
events_for_issue = gk_events[event_issue_id == issue$issue_id]
```



