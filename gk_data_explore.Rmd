---
title: "Greenkeeper Data Explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("gk_load_data.R")
```

## General Stats
- 123,089 Issues opened by Greenkeeper (GKI)
- 79,079 GKIs with issue_dependency_name, actual_version, and next_version
- 7 types of issue body parsers on the GKIs
  - BundleUpdateIssueBodyParser (18,582)
  - NewDepVersionIssueBodyParser (28,708)
  - NewDepVersion2IssueBodyParser (5,977)
  - NewDepVersion3IssueBodyParser (233)
  - NewDepVersion4IssueBodyParser (3,245)
  - NewDepUpdatedFromToIssueBodyParser (60,497)
  - NewDepUpdatedFromTo2IssueBodyParser (61)


## RQ1: Types of updates (major, minor, patch) that break a client's build
Of 79,079 GKIs:
- Major: 122
- Minor: 27226
- Patch: 51731


How often are Greenkeeper Issues closed?
```{r}
n_issues <- nrow(issues)
n_closed_issues <- nrow(issues[issue_state == "closed"])
paste(
  percent(
    n_closed_issues / n_issues
  ), "of Greenkeeper issues are eventually closed"
)
```

How much time do Greenkeeper issues take to be closed?
```{r}
closed_issues <- issues[issue_state == "closed"]
# calculate median time to close issue
time_to_close_issue <-
  closed_issues[, 
                .(issue_id, 
                  time_to_close_issue=difftime(ymd_hms(issue_closed_at), ymd_hms(issue_created_at), units = "hours"))]

# report the median time to close the issue
paste("The median time to close the issue is",
      median(as.numeric(time_to_close_issue$time_to_close_issue)),
             "hours")

# plot the distribution
ggplot(time_to_close_issue, aes(x="", y=as.numeric(time_to_close_issue))) +
  geom_violin(fill="mediumspringgreen") +
  geom_boxplot(width=0.05, fill="mediumslateblue") +
  scale_x_discrete(name="Greenkeeper Issue Report") +
  scale_y_log10(name="Time to close Issue (hours)",
                labels=trans_format("log10", math_format(10^.x))) +
  theme_classic() +
  theme(axis.ticks.x=element_blank())


print(paste("Five number summary for the time to close the Greenkeeper issue:"))
summary(as.numeric(time_to_close_issue$time_to_close_issue))
```



What is the proportion of open issues that are older than the median time to close an issue?
```{r}
open_issues <-
  issues[issue_state == "open"]

# get latest date for open issue
latest_issue <-
  max(open_issues$issue_updated_at)

# calculate the life-time of the issue
open_issues[,
            lifetime := 
              difftime(ymd_hms(latest_issue),
                       ymd_hms(issue_updated_at),
                       units="hours")]

# get the median time to close an issue
median_time_to_close_issue =
  median(as.numeric(time_to_close_issue$time_to_close_issue))

paste(
  percent(
    nrow(open_issues) / nrow(open_issues[lifetime > median_time_to_close_issue])
    ), "of the open issues have a lifetime larger than the median time to close an issue."
)
```

How many comments do Greenkeeper Breaking Issues have? How many of these are from Greenkeeper?
```{r}
library(viridis)
ggplot(issues, aes(x="", y=issue_num_comments, fill=issue_state)) +
  geom_violin(width=1.4) +
  #geom_boxplot(width=0.1, color="grey", alpha=0.2) +
  scale_x_discrete(name="Greenkeeper Issue Report") +
  scale_y_log10(oob=scales::squish_infinite, name="Number of Comments", labels=trans_format("log10", math_format(10^.x)))

print(paste("Five number summary for the number of comments on Greenkeeper Breakage issues:"))
summary(as.numeric(issues$issue_num_comments))

paste(
  percent(
    nrow(comments[comment_user_type == "Bot" & comment_user_login %like% "greenkeeper"]) / nrow(comments)
    ), "of the comments on breaking issue reports opened by Greenkeeper are from the Greenkeeper bot."
)
```




### Random sample of Major Breakages
93/122 (95% Confidence Level, 5% Confidence Interval)
```{r}
set.seed(100)
major_sample = sample_n(gki_with_dependency[update_type == "major"], size=93)
head(major_sample)
```

### Random sample of Minor Breakages
379/27226 (95% Confidence Level, 5% Confidence Interval)
```{r}
set.seed(100)
minor_sample = sample_n(gki_with_dependency[update_type == "minor"], size=379)
```

### Random sample of Patch Breakages
381/51731 (95% Confidence Level, 5% Confidence Interval)
```{r}
set.seed(100)
patch_sample = sample_n(gki_with_dependency[update_type == "patch"], size=381)
head(patch_sample)
```



```{r link_dataset}


package_names[, package_id := 
                str_match(package_gh_url,
                          "^https://github\\.com/(.*?)/$")[,2]]

init_pr[, init_pr_id := 
          str_match(pr_repo_url,
                    "^https://api.github.com/repos/(.*?)$")[,2]]

issues[, issue_id := 
         str_match(issue_repo_url,
                    "^https://api.github.com/repos/(.*?)$")[,2]
         ]

```

